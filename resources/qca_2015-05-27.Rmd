---
title: "QCA Results"
author: "Thomas Elliott"
date: "June 9, 2015"
output:
  html_document:
    highlight: kate
    theme: spacelab
  pdf_document: default
  word_document:
    highlight: kate
---



```{r,include=FALSE}
knitr::opts_chunk$set(comment=NA)

library(readxl)
library(foreign)
library(QCA)
library(dplyr)
library(stringr)

bolNA<-function(test,yes,no) {
  ans<-ifelse(test,yes,no)
  ans<-ifelse(is.na(ans),no,ans)
  ans
}

setwd("/Users/burrelvannjr/Dropbox/Runs Share")

headline.terms<-read_excel("Data/headline_terms.xlsx")

load("Data/runs_coding.Rdata")
data$frontpage<-(data$page=="1"|data$page=="A1")*1
data$Rdate<-as.Date(data$date)
data$runstart<-as.Date(data$runstart)
data$runend<-as.Date(data$runend)
data<-data %>% mutate(sixbefore=runstart-180,
                      sixafter=runend+180,
                      VIP=0,
                      title=tolower(headline))
smoids<-data %>% select(smoid) %>% distinct() %>% .$smoid
for(i in smoids ) {
  ht<-headline.terms %>% filter(OrgLeader==1|OrgMember==1) %>%
    filter(smoid==i) %>% .$term %>% tolower() %>% str_trim()
  if ( length(ht) > 0 ) {
    pattern<-paste(ht,collapse="|")
    data<-data %>% mutate(VIP=ifelse(grepl(pattern,title)&smoid==i,1,VIP))
  }
}
full<-data


data<-data %>% filter(notCoded==0&num_errors==0&paragraphs>1) %>%
  filter(Rdate>=sixbefore&Rdate<=sixafter)

#create outcome sets
data<-data %>% rename(Standing=standing) %>% 
  mutate(Demand=claim,
         Issue=(attentionissue==1)*1,
         DI=pmax(Demand,Issue))

#create causal sets
data<-data %>% rename(Headline=inheadline) %>%
  mutate(Initiated=bolNA(initsmo==1,1,0),
         King=bolNA(grepl("king",title)&smoid==405,1,0),
         OtherInitiated=bolNA(occasion==4,1,0),
         CA=bolNA(smoca==1,1,0),
         OtherCA=bolNA(othersmoca==1,1,0),
         Assertive=bolNA(catype==6,1,0),
         CivilDis=bolNA(catype==3,1,0),
         Protest=bolNA(catype==2|catype==3,1,0),
         Boycott=bolNA(catype==5,1,0),
         Violence=bolNA(catype==4,1,0),
         ActedOn=bolNA(actedon!=0,1,0),
         VotingRights=bolNA(Rdate>=as.Date("1965-04-09")&
                              Rdate<=as.Date("1965-08-06"),1,0),
         National=bolNA(newsdesk==1,1,0),
         Local=bolNA(newsdesk==3,1,0),
         Conservative=bolNA(smoid==1217|smoid==609,1,0),
         Radical=bolNA(smoid==362|smoid==609|smoid==1217,1,0),
         Long=bolNA(paragraphs==4,1,0),
         NonViolent=bolNA(smoca==1&catype!=4,1,0),
         Analysis=bolNA(texttype==2,1,0),
         MainlySMO=bolNA(attentionsmo==3,1,0))

cutoff<-0.8
```


#Black Panthers
```{r}
df<-data %>% filter(smoid==362) %>% select(DI,Local,ActedOn,NonViolent,OtherCA,Initiated,Long,Headline,article_id)
rownames(df)<-df$article_id
df<-df %>% select(-article_id)
truth<-truthTable(df,outcome="DI",sort.by="incl",incl.cut1=.4)
print(truth)
sol<-eqmcc(truth,details=TRUE,show.cases=FALSE)
print(sol)
```

##Intermediate Solution
```{r}
sol<-eqmcc(truth,details=TRUE,include="?",dir.exp=c(1,1,1,1,1,1,1))
print(sol)
```

The solution identifies the following articles as having the outcome:
```{r,echo=FALSE}
pims<-sol$pims
solutions<-names(pims)
coords<-which(pims==1,arr.ind=TRUE)
for(i in c( 1:length(solutions) ) ) {
  print(solutions[i])
  ids<-as.integer(names(which(coords[,2]==i)))
  data %>% filter(article_id%in%ids) %>% distinct(article_id) %>%
    select(headline,date) %>% 
    mutate(headline=substr(headline,1,40)) %>% print()
}
```

#KKK
```{r}
df<-data %>% filter(smoid==1217) %>% select(DI,ActedOn,NonViolent,OtherCA,Initiated,Long,Headline,article_id)
rownames(df)<-df$article_id
df<-df %>% select(-article_id)
truth<-truthTable(df,outcome="DI",sort.by="incl",incl.cut1=.65)
print(truth)
sol<-eqmcc(truth,details=TRUE,show.cases=FALSE)
print(sol)
```

##Intermediate Solution
```{r}
sol<-eqmcc(truth,details=TRUE,include="?",dir.exp=c(1,1,1,1,1,1))
print(sol)
```

The solution identifies the following articles as having the outcome:
```{r,echo=FALSE}
pims<-sol$pims
solutions<-names(pims)
coords<-which(pims==1,arr.ind=TRUE)
for(i in c( 1:length(solutions) ) ) {
  print(solutions[i])
  ids<-as.integer(names(which(coords[,2]==i)))
  data %>% filter(article_id%in%ids) %>% distinct(article_id) %>%
    select(headline,date) %>% 
    mutate(headline=substr(headline,1,40)) %>% print()
}
```


#John Birch
```{r}
df<-data %>% filter(smoid==609) %>% select(DI,VIP,CA,Initiated,Long,Headline,Local,OtherCA,article_id)
rownames(df)<-df$article_id
df<-df %>% select(-article_id)
truth<-truthTable(df,outcome="DI",sort.by="incl",incl.cut1=.65)
print(truth)
sol<-eqmcc(truth,details=TRUE,show.cases=FALSE)
print(sol)
```

##Intermediate Solution
```{r}
sol<-eqmcc(truth,details=TRUE,include="?",dir.exp=c(1,1,1,1,1,1,1))
print(sol)
```

The solution identifies the following articles as having the outcome:
```{r,echo=FALSE}
pims<-sol$pims
solutions<-names(pims)
coords<-which(pims==1,arr.ind=TRUE)
for(i in c( 1:length(solutions) ) ) {
  print(solutions[i])
  ids<-as.integer(names(which(coords[,2]==i)))
  data %>% filter(article_id%in%ids) %>% distinct(article_id) %>%
    select(headline,date) %>% 
    mutate(headline=substr(headline,1,40)) %>% print()
}
```


#All Three
```{r}
df<-data %>% filter(smoid==1217|smoid==362) %>% select(DI,ActedOn,CA,Initiated,Long,Headline,Local,OtherCA,article_id)
rownames(df)<-df$article_id
df<-df %>% select(-article_id)
truth<-truthTable(df,outcome="DI",sort.by="incl",incl.cut1=.65)
print(truth)
sol<-eqmcc(truth,details=TRUE,show.cases=FALSE)
print(sol)
```

##Intermediate Solution
```{r}
sol<-eqmcc(truth,details=TRUE,include="?",dir.exp=c(1,1,1,1,1,1,1))
print(sol)
```

The solution identifies the following articles as having the outcome:
```{r,echo=FALSE}
pims<-sol$pims
solutions<-names(pims)
coords<-which(pims==1,arr.ind=TRUE)
for(i in c( 1:length(solutions) ) ) {
  print(solutions[i])
  ids<-as.integer(names(which(coords[,2]==i)))
  data %>% filter(article_id%in%ids) %>% distinct(article_id) %>%
    select(headline,date) %>% 
    mutate(headline=substr(headline,1,40)) %>% print()
}
```







#SCLC
```{r}
df<-data %>% filter(smoid==405) %>% select(DI,Assertive,Initiated,Long,VIP,article_id)
rownames(df)<-df$article_id
df<-df %>% select(-article_id)
truth<-truthTable(df,outcome="DI",sort.by="incl",incl.cut1=.75)
print(truth)
```

##Complex Solution
```{r}
sol<-eqmcc(truth,details=TRUE,show.cases=FALSE)
print(sol)
```

##Intermediate Solution
```{r}
sol<-eqmcc(truth,details=TRUE,include="?",dir.exp=c(1,1,1,1))
print(sol)
```



#SNCC
```{r}
df<-data %>% filter(smoid==408) %>% select(DI,Assertive,Initiated,Long,VIP,article_id)
rownames(df)<-df$article_id
df<-df %>% select(-article_id)
truth<-truthTable(df,outcome="DI",sort.by="incl",incl.cut1=.75)
print(truth)
```

##Complex Solution
```{r}
sol<-eqmcc(truth,details=TRUE,show.cases=FALSE)
print(sol)
```

##Intermediate Solution
```{r}
sol<-eqmcc(truth,details=TRUE,include="?",dir.exp=c(1,1,1,1))
print(sol)
```



#NAACP
```{r}
df<-data %>% filter(smoid==387) %>% select(DI,Assertive,Initiated,Long,VIP,article_id)
rownames(df)<-df$article_idz
df<-df %>% select(-article_id)
truth<-truthTable(df,outcome="DI",sort.by="incl",incl.cut1=.75)
print(truth)
```

##Complex Solution
```{r}
sol<-eqmcc(truth,details=TRUE,show.cases=FALSE)
print(sol)
```

##Intermediate Solution
```{r}
sol<-eqmcc(truth,details=TRUE,include="?",dir.exp=c(1,1,1,1))
print(sol)
```



#All Three
```{r}
df<-data %>% filter(smoid==387|smoid==405|smoid==408) %>% select(DI,Assertive,Initiated,Long,VIP,King,article_id) %>%
  mutate(VIP=ifelse(King==1,0,VIP))
df<-df %>% select(-article_id)
truth<-truthTable(df,outcome="DI",sort.by="incl",incl.cut1=.74)
print(truth)
```

##Complex Solution
```{r}
sol<-eqmcc(truth,details=TRUE,show.cases=FALSE)
print(sol)
```

##Intermediate Solution
```{r}
sol<-eqmcc(truth,details=TRUE,include="?",dir.exp=c(1,1,1,1,1))
print(sol)
```